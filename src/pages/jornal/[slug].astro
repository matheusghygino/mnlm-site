---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { Image } from "astro:assets";
import { getPosts } from "../../lib/jornal/getPosts";
import PostContent from "../../components/jornal/PostContent.astro";
import JournalTabsNav from "../../components/jornal/JornalTabsNav";
import type { JournalTab } from "../../lib/jornal/types";


export async function getStaticPaths() {
  const posts = await getPosts();
  return posts.map((post) => ({
    params: { slug: post.slug },
  }));
}

const { slug } = Astro.params;
const posts = await getPosts();
const post = posts.find((p) => p.slug === slug);

if (!post) return Astro.redirect("/jornal");

const isBoletim = post.type === "boletim";

const accentColor = isBoletim ? "var(--color-boletim)" : "var(--color-jornal)";
const accentBg = isBoletim ? "rgba(0,102,204,0.12)" : "rgba(195,0,0,0.12)";

function formatDatePtBR(iso: string): string {
  return new Date(iso).toLocaleDateString("pt-BR", {
    weekday: "long",
    day: "2-digit",
    month: "long",
    year: "numeric",
  });
}

// posts do mesmo tipo (tribuna ou boletim)
const sameTypePosts = posts
  .filter((p) => p.type === post.type)
  .sort((a, b) => new Date(b.publishedAt).getTime() - new Date(a.publishedAt).getTime());

// √≠ndice do post atual
const currentIndex = sameTypePosts.findIndex((p) => p.slug === post.slug);

// navega√ß√£o
const previousPost =
  currentIndex < sameTypePosts.length - 1 ? sameTypePosts[currentIndex + 1] : null;

const nextPost = currentIndex > 0 ? sameTypePosts[currentIndex - 1] : null;

// hash do "ver todos"
const backHash = post.type === "boletim" ? "boletim" : "tribuna";

// ‚úÖ tab ativa para o nav (no slug s√≥ faz sentido tribuna/boletim)
const activeTab: JournalTab = post.type === "boletim" ? "boletim" : "tribuna";


---

<BaseLayout title={`${post.title} | MNLM`}>
  <main class="bg-bg py-16">
    <!-- NAV IGUAL AO JORNALTABS (link-only) -->
    <JournalTabsNav active={activeTab} />

    <!-- ARTIGO -->
    <article
      class="relative mx-auto mt-8 max-w-3xl rounded-2xl bg-card-bg border-border px-4 py-8 shadow-sm md:px-8 md:py-10"
      style={`border-left: 6px solid ${accentColor};`}
    >
      <!-- META -->
      <span
        class="inline-block rounded-full px-4 py-1 text-xs font-bold uppercase"
        style={`background:${accentBg};color:${accentColor}`}
      >
        {isBoletim ? "BOLETIM" : "JORNAL"}
      </span>

      <p class="mt-4 text-sm font-mono" style={`color:${accentColor}`}>
        {formatDatePtBR(post.publishedAt)}
      </p>

      <!-- T√çTULO -->
      <h1 class="mt-4 text-4xl font-extrabold leading-tight md:text-5xl">
        {post.title}
      </h1>

      <!-- EXCERPT -->
      <p class="mt-6 text-base leading-relaxed text-text-secondary text-justify">
        {post.excerpt}
      </p>

      <!-- A√á√ïES -->
      <div class="mt-6 flex flex-col gap-4">
        <button
          id="shareBtn"
          class="w-fit rounded-full px-5 py-2 text-sm font-semibold"
          style={`background:${accentBg};color:${accentColor}`}
        >
          üîó Compartilhar
        </button>

        <div class="flex flex-wrap items-center gap-4 text-sm">
          <span>{post.readingTime} de leitura</span>

          <span
            class="rounded-full bg-[var(--color-autor-bg)] px-4 py-1 font-semibold text-[var(--color-autor)]"
          >
            üë§ {post.author}
          </span>
        </div>
      </div>

      <!-- TAGS -->
      <div class="mt-6 flex flex-wrap gap-2">
        {post.tags.map((tag) => (
          <span
            class="rounded-full px-3 py-1 text-xs font-semibold uppercase"
            style={`background:${accentBg};color:${accentColor}`}
          >
            {tag}
          </span>
        ))}
      </div>

      <!-- IMAGEM PRINCIPAL -->
      <figure
        class="group mt-10 overflow-hidden rounded-xl bg-neutral-100 transition-all duration-300 hover:-translate-y-1 hover:shadow-lg"
      >
        <Image
          src={post.coverImage}
          alt={post.title}
          widths={[600, 900, 1200]}
          sizes="(max-width: 768px) 100vw, 768px"
          format="webp"
          quality={75}
          class="w-full"
          loading="eager"
        />

        {post.coverCaption && (
          <figcaption class="bg-neutral-100 px-4 py-3 text-center text-xs italic text-text-secondary">
            {post.coverCaption}
          </figcaption>
        )}
      </figure>

      <!-- CONTE√öDO -->
      <div class="mt-12">
        <PostContent content={post.content} variant={post.type} />
      </div>

      <!-- NAVEGA√á√ÉO FINAL -->
      <nav class="mt-16 flex items-center justify-between gap-4 border-t border-border-light pt-8">
        <div>
          {previousPost ? (
            <a
              href={`/jornal/${previousPost.slug}`}
              class="inline-flex items-center gap-2 rounded-full border border-border-light px-6 py-2 text-sm font-medium text-text-secondary transition hover:bg-neutral-100"
            >
              ‚Üê Anterior
            </a>
          ) : (
            <span />
          )}
        </div>

        <div>
          <a
            href={`/jornal#${backHash}`}
            class="inline-flex items-center gap-2 rounded-full border border-border-light px-6 py-2 text-sm font-medium text-text-secondary transition hover:bg-neutral-100"
          >
            ‚¨ö Ver Todos
          </a>
        </div>

        <div>
          {nextPost ? (
            <a
              href={`/jornal/${nextPost.slug}`}
              class="inline-flex items-center gap-2 rounded-full border border-border-light px-4 py-2 text-sm font-medium text-text-secondary transition hover:bg-neutral-100"
            >
              Pr√≥ximo ‚Üí
            </a>
          ) : (
            <span />
          )}
        </div>
      </nav>

      <!-- SHARE SCRIPT -->
      <script is:inline>
        const btn = document.getElementById("shareBtn");
        btn?.addEventListener("click", async () => {
          const url = window.location.href;
          if (navigator.share) {
            await navigator.share({ url });
            return;
          }
          await navigator.clipboard.writeText(url);
          alert("Link copiado!");
        });
      </script>
    </article>
  </main>
</BaseLayout>
